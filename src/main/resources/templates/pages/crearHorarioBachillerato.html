<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Horarios</title>
    <link rel="stylesheet" th:href="@{/css/registroHorarios.css}">
    <link rel="icon" th:href="@{/images/faviconLogo.png}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/panelAdmin.css}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .custom-dropdown.active .dropdown-options { display: block !important; }
        .schedule-table td div { line-height: 1.2; }
    </style>
</head>

<body>

<header class="header">
    <h1>Horarios de Bachillerato</h1>
</header>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="container mx-auto p-4">

    <section class="selection-bar-container">
        <div class="selection-grid">
            <div class="selector-group">
                <h2 class="selector-label">Elije el Curso</h2>
                <div class="custom-dropdown" id="dropdownCurso">
                    <div class="dropdown-selected" onclick="toggleCustomDropdown('dropdownCurso')">
                        <span id="textCurso">Seleccione Curso...</span>
                        <i class="fas fa-caret-down arrow-icon"></i>
                    </div>
                    <div class="dropdown-options">
                        <div class="dropdown-item" onclick="selectItem('curso', '1ro BGU')">1ro BGU</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '2do BGU')">2do BGU</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '3ro BGU')">3ro BGU</div>
                    </div>
                </div>
            </div>

            <div class="selector-group">
                <h2 class="selector-label">Elije el Paralelo</h2>
                <div class="custom-dropdown" id="dropdownParalelo">
                    <div class="dropdown-selected" onclick="toggleCustomDropdown('dropdownParalelo')">
                        <span id="textParalelo">Seleccione Paralelo...</span>
                        <i class="fas fa-caret-down arrow-icon"></i>
                    </div>
                    <div class="dropdown-options">
                        <div class="dropdown-item" onclick="selectItem('paralelo', 'A')">Paralelo A</div>
                        <div class="dropdown-item" onclick="selectItem('paralelo', 'B')">Paralelo B</div>
                        <div class="dropdown-item" onclick="selectItem('paralelo', 'C')">Paralelo C</div>
                        <div class="dropdown-item" onclick="selectItem('paralelo', 'D')">Paralelo D</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="schedule-section mb-10">
        <div class="flex justify-between items-center mb-4">
            <h2 class="section-title">Jornada Matutina</h2>
            <button onclick="enviarJornada('Matutina')"
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow-md">
                <i class="fas fa-save mr-2"></i> GUARDAR MATUTINA
            </button>
        </div>
        <div class="table-container">
            <table class="schedule-table">
                <thead>
                <tr>
                    <th class="text-center">Hora</th>
                    <th>LUNES</th>
                    <th>MARTES</th>
                    <th>MIÉRCOLES</th>
                    <th>JUEVES</th>
                    <th>VIERNES</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="h : ${ {'07:00 - 07:45', '07:45 - 08:30', '08:30 - 09:15', '09:15 - 10:00'} }">
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td th:each="d : ${#numbers.sequence(1,5)}">
                        <button class="add-btn" onclick="openModal(this)">+</button>
                    </td>
                </tr>
                <tr th:each="h : ${ {'10:00 - 10:30'} }" >
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td colspan="5" class="p-2">
                        <div class="h-full py-3 flex items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-gray-400 font-bold shadow-inner transition-all hover:bg-gray-100">
                            <i class="fas fa-mug-hot text-gray-300 mr-4 text-sm"></i>
                            <span class="tracking-[0.8em] text-3xl font-black text-gray-400">RECREO</span>
                            <i class="fas fa-cookie-bite text-gray-300 ml-2 text-sm"></i>
                        </div>
                    </td>
                </tr>
                <tr th:each="h : ${ {'10:30 - 11:15', '11:15 - 12:00', '12:00 - 12:45'} }">
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td th:each="d : ${#numbers.sequence(1,5)}">
                        <button class="add-btn" onclick="openModal(this)">+</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <section class="schedule-section">
        <div class="flex justify-between items-center mb-4">
            <h2 class="section-title">Jornada Vespertina</h2>
            <button onclick="enviarJornada('Vespertina')"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-md">
                <i class="fas fa-save mr-2"></i> GUARDAR VESPERTINA
            </button>
        </div>
        <div class="table-container">
            <table class="schedule-table">
                <thead>
                <tr>
                    <th class="text-center">Hora</th>
                    <th>LUNES</th>
                    <th>MARTES</th>
                    <th>MIÉRCOLES</th>
                    <th>JUEVES</th>
                    <th>VIERNES</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="h : ${ {'13:00 - 13:45', '13:45 - 14:30', '14:30 - 15:15', '15:15 - 16:00'} }">
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td th:each="d : ${#numbers.sequence(1,5)}">
                        <button class="add-btn" onclick="openModal(this)">+</button>
                    </td>
                </tr>
                <tr th:each="h : ${ {'16:00 - 16:30' } }" >
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td colspan="5" class="p-2">
                        <div class="h-full py-3 flex items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-gray-400 font-bold shadow-inner transition-all hover:bg-gray-100">
                            <i class="fas fa-mug-hot text-gray-300 mr-4 text-m"></i>
                            <span class="tracking-[0.8em] text-3xl font-black text-gray-400">RECREO</span>
                            <i class="fas fa-cookie-bite text-gray-300 ml-1 text-m"></i>
                        </div>
                    </td>
                </tr>
                <tr th:each="h : ${ {'16:30 - 17:15', '17:15 - 18:00', '18:00 - 18:45' } }">
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td th:each="d : ${#numbers.sequence(1,5)}">
                        <button class="add-btn" onclick="openModal(this)">+</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

</main>

<div id="classModal" class="modal-overlay" style="display: none;">
    <div class="modal-content max-w-md w-full m-4">
        <div class="modal-header flex justify-between items-center pb-3 border-b">
            <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-calendar-plus mr-2 text-blue-600"></i>Agregar
                Clase</h3>
            <span class="close-modal cursor-pointer text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body space-y-4 py-4">
            <div class="form-group">
                <label class="block text-sm font-semibold text-gray-700 mb-1"><i
                        class="fas fa-search text-blue-600 mr-1"></i>Buscar Profesor</label>
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="buscarDocente"
                           class="form-control w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           placeholder="Escriba para buscar..." oninput="filtrarDocentes()">
                </div>
            </div>
            <div class="form-group">
                <label class="block text-sm font-semibold text-gray-700 mb-1"><i
                        class="fas fa-chalkboard-teacher text-green-600 mr-1"></i>Profesor Responsable</label>
                <select id="modalDocente"
                        class="form-control w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500"
                        onchange="actualizarMateriaPorDocente()" size="4">
                    <option value="" disabled selected>Cargando docentes...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="block text-sm font-semibold text-gray-700 mb-1"><i
                        class="fas fa-book text-purple-600 mr-1"></i>Materia</label>
                <input type="text" id="modalMateria"
                       class="form-control w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50" readonly>
            </div>
        </div>
        <div class="modal-footer flex justify-end space-x-3 pt-4 border-t">
            <button class="px-5 py-2.5 border rounded-lg text-gray-700" onclick="closeModal()">Cancelar</button>
            <button class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-semibold" onclick="guardarClase()">
                Guardar
            </button>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    let currentButton = null;
    let horariosTemporales = [];
    let docentesCache = [];

    function openModal(button) {
        const curso = document.getElementById('textCurso').innerText;
        const paralelo = document.getElementById('textParalelo').innerText;
        if (curso.includes("Seleccione") || paralelo.includes("Seleccione")) {
            return alert("⚠️ Por favor, selecciona primero el Curso y el Paralelo.");
        }
        currentButton = button;
        document.getElementById('classModal').style.display = 'flex';
        if (docentesCache.length === 0) cargarDocentes();
    }

    function closeModal() {
        document.getElementById('classModal').style.display = 'none';
        document.getElementById('buscarDocente').value = '';
        currentButton = null;
    }

    async function cargarDocentes() {
        const response = await fetch('/api/docentes');
        docentesCache = await response.json();
        renderizarDocentes(docentesCache);
    }

    function renderizarDocentes(docentes) {
        const select = document.getElementById('modalDocente');
        select.innerHTML = docentes.map(d => `<option value="${d.id}" data-materia="${d.materia}">${d.nombre}</option>`).join('');
    }

    function filtrarDocentes() {
        const val = document.getElementById('buscarDocente').value.toLowerCase();
        renderizarDocentes(docentesCache.filter(d => d.nombre.toLowerCase().includes(val)));
    }

    function actualizarMateriaPorDocente() {
        const sel = document.getElementById('modalDocente');
        if (sel.selectedIndex !== -1) {
            document.getElementById('modalMateria').value = sel.options[sel.selectedIndex].getAttribute('data-materia');
        }
    }

    function toggleCustomDropdown(id) {
        document.getElementById(id).classList.toggle('active');
    }

    function selectItem(type, value) {
        document.getElementById(type === 'curso' ? 'textCurso' : 'textParalelo').innerText = value;
        document.getElementById(type === 'curso' ? 'dropdownCurso' : 'dropdownParalelo').classList.remove('active');
    }

    async function guardarClase() {
        const select = document.getElementById('modalDocente');
        if (!select.value) return alert("Seleccione un docente");

        const cell = currentButton.parentElement;
        const dia = cell.closest('table').querySelectorAll('thead th')[cell.cellIndex].innerText.toUpperCase();
        const [inicio, fin] = cell.closest('tr').querySelector('.time-col').innerText.split(' - ');

        const curso = document.getElementById('textCurso').innerText;
        const paralelo = document.getElementById('textParalelo').innerText.replace("Paralelo ", "");
        const horaInicioEnvio = inicio + ":00";
        const docenteId = select.value;

        // --- VALIDACIÓN DE CRUCE ---
        try {
            const res = await fetch(`/horario/validarCruce?docenteId=${docenteId}&diaSemana=${dia}&horaInicio=${horaInicioEnvio}&curso=${encodeURIComponent(curso)}&paralelo=${encodeURIComponent(paralelo)}`);
            if (res.ok) {
                const conflicto = await res.json();
                if (conflicto) {
                    if (conflicto.curso === curso && conflicto.paralelo === paralelo) {
                        alert(`❌ ESPACIO OCUPADO: Ya existe ${conflicto.materia} aquí.`);
                        return;
                    }
                    alert(`ℹ️ AVISO: El docente ya tiene clase en ${conflicto.curso} (${conflicto.paralelo}) a esta hora.`);
                }
            }
        } catch (e) { console.log("Sin conflictos en DB"); }

        const tempId = Date.now();
        const registro = {
            tempId,
            curso: curso,
            paralelo: paralelo,
            jornada: cell.closest('.schedule-section').querySelector('.section-title').innerText.includes("Matutina") ? "Matutina" : "Vespertina",
            diaSemana: dia,
            horaInicio: horaInicioEnvio,
            horaFin: fin + ":00",
            materia: document.getElementById('modalMateria').value,
            docente: { id: parseInt(docenteId) }
        };

        horariosTemporales.push(registro);
        cell.innerHTML = `
            <div class="relative group w-full h-full flex flex-col justify-center px-4 py-4 bg-emerald-50 border-l-4 border-l-emerald-500 transition-all duration-300 hover:bg-emerald-100">
                <div class="flex flex-col gap-1.5">
                    <span class="text-[15px] font-black text-emerald-900 uppercase tracking-tight leading-none">${registro.materia}</span>
                    <div class="flex items-center gap-2 text-[13px] text-emerald-700">
                        <i class="fas fa-chalkboard-user opacity-80"></i>
                        <span class="truncate font-bold">${select.options[select.selectedIndex].text}</span>
                    </div>
                </div>
                <button onclick="resetCell(this, ${tempId})" class="absolute top-1 right-1 w-7 h-7 flex items-center justify-center bg-white text-emerald-600 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-500 hover:text-white transition-all shadow-md">
                    <i class="fas fa-times text-[12px]"></i>
                </button>
            </div>`;
        closeModal();
    }

    function resetCell(btn, tid) {
        btn.closest('td').innerHTML = `<button class="add-btn" onclick="openModal(this)">+</button>`;
        horariosTemporales = horariosTemporales.filter(h => h.tempId !== tid);
    }

    async function enviarJornada(jornadaNombre) {
        const data = horariosTemporales.filter(h => h.jornada === jornadaNombre);
        if (data.length === 0) return alert("No hay datos para guardar.");

        if (confirm(`¿Guardar jornada ${jornadaNombre}?`)) {
            const finalData = data.map(({tempId, ...rest}) => rest);
            const res = await fetch('/horario/guardarLote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalData)
            });
            if (res.ok) {
                alert("✅ Guardado exitoso.");
                location.reload();
            } else {
                alert("❌ Error al guardar.");
            }
        }
    }

    window.onclick = function(e) {
        if (!e.target.closest('.custom-dropdown')) {
            document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active'));
        }
    };
</script>
</body>
</html>