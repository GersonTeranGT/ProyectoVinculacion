<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Horarios - Básica</title>
    <link rel="stylesheet" th:href="@{/css/registroHorarios.css}">
    <link rel="icon" th:href="@{/images/faviconLogo.png}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/panelAdmin.css}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<header class="header">
    <h1>Horarios de Educación Básica e Inicial</h1>
</header>

<div th:replace="fragments/navbar :: navbar"></div>

<main class="container mx-auto p-4">

    <section class="selection-bar-container">
        <div class="selection-grid">
            <div class="selector-group">
                <h2 class="selector-label">Elije el Curso</h2>
                <div class="custom-dropdown" id="dropdownCurso">
                    <div class="dropdown-selected" onclick="toggleCustomDropdown('dropdownCurso')">
                        <span id="textCurso">Seleccionar Curso</span>
                        <i class="fas fa-caret-down arrow-icon"></i>
                    </div>
                    <div class="dropdown-options">
                        <div class="dropdown-item" onclick="selectItem('curso', 'Inicial 1')">Inicial 1</div>
                        <div class="dropdown-item" onclick="selectItem('curso', 'Inicial 2')">Inicial 2</div>
                        <hr class="border-gray-200 my-1">
                        <div class="dropdown-item" onclick="selectItem('curso', '1ro. Básica')">1ro. Básica</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '2do. Básica')">2do. Básica</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '3ro. Básica')">3ro. Básica</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '4to. Básica')">4to. Básica</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '5to. Básica')">5to. Básica</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '6to. Básica')">6to. Básica</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '7mo. Básica')">7mo. Básica</div>
                        <hr class="border-gray-200 my-1">
                        <div class="dropdown-item" onclick="selectItem('curso', '8vo EGB')">8vo EGB</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '9no EGB')">9no EGB</div>
                        <div class="dropdown-item" onclick="selectItem('curso', '10mo EGB')">10mo EGB</div>
                    </div>
                </div>
            </div>

            <div class="selector-group">
                <h2 class="selector-label">Elije el Paralelo</h2>
                <div class="custom-dropdown" id="dropdownParalelo">
                    <div class="dropdown-selected" onclick="toggleCustomDropdown('dropdownParalelo')">
                        <span id="textParalelo">Seleccionar Paralelo</span>
                        <i class="fas fa-caret-down arrow-icon"></i>
                    </div>
                    <div class="dropdown-options">
                        <div class="dropdown-item" onclick="selectItem('paralelo', 'A')">Paralelo A</div>
                        <div class="dropdown-item" onclick="selectItem('paralelo', 'B')">Paralelo B</div>
                        <div class="dropdown-item" onclick="selectItem('paralelo', 'C')">Paralelo C</div>
                        <div class="dropdown-item" onclick="selectItem('paralelo', 'D')">Paralelo D</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="schedule-section">
        <div class="flex justify-between items-center mb-4">
            <h2 class="section-title">Jornada Matutina</h2>
            <button onclick="enviarJornada('Matutina')"
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow-md transition-all">
                <i class="fas fa-save mr-2"></i> GUARDAR JORNADA MATUTINA
            </button>
        </div>
        <div class="table-container">
            <table class="schedule-table" id="tablaMatutina">
                <thead>
                <tr>
                    <th class="text-center">Hora</th>
                    <th>LUNES</th>
                    <th>MARTES</th>
                    <th>MIÉRCOLES</th>
                    <th>JUEVES</th>
                    <th>VIERNES</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="h : ${ {'07:00 - 07:45', '07:45 - 08:30', '08:30 - 09:15', '09:15 - 10:00'} }">
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td th:each="d : ${#numbers.sequence(1,5)}">
                        <button class="add-btn" onclick="openModal(this)">+</button>
                    </td>
                </tr>
                <tr>
                    <td class="time-col text-center font-bold">10:00 - 10:30</td>
                    <td colspan="5" class="p-2">
                        <div class="h-full py-3 flex items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-gray-400 font-bold shadow-inner">
                            <span class="tracking-[0.8em] text-3xl font-black text-gray-400">RECREO</span>
                        </div>
                    </td>
                </tr>
                <tr th:each="h : ${ {'10:30 - 11:15', '11:15 - 12:00'} }">
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td th:each="d : ${#numbers.sequence(1,5)}">
                        <button class="add-btn" onclick="openModal(this)">+</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <section class="schedule-section mt-10">
        <div class="flex justify-between items-center mb-4">
            <h2 class="section-title">Jornada Vespertina</h2>
            <button onclick="enviarJornada('Vespertina')"
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow-md transition-all">
                <i class="fas fa-save mr-2"></i> GUARDAR JORNADA VESPERTINA
            </button>
        </div>
        <div class="table-container">
            <table class="schedule-table" id="tablaVespertina">
                <thead>
                <tr>
                    <th class="text-center">Hora</th>
                    <th>LUNES</th>
                    <th>MARTES</th>
                    <th>MIÉRCOLES</th>
                    <th>JUEVES</th>
                    <th>VIERNES</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="h : ${ {'13:00 - 13:45', '13:45 - 14:30', '14:30 - 15:15', '15:15 - 16:00'} }">
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td th:each="d : ${#numbers.sequence(1,5)}">
                        <button class="add-btn" onclick="openModal(this)">+</button>
                    </td>
                </tr>
                <tr>
                    <td class="time-col text-center font-bold">16:00 - 16:30</td>
                    <td colspan="5" class="p-2">
                        <div class="h-full py-3 flex items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-gray-400 font-bold shadow-inner">
                            <span class="tracking-[0.8em] text-3xl font-black text-gray-400">RECREO</span>
                        </div>
                    </td>
                </tr>
                <tr th:each="h : ${ {'16:30 - 17:15', '17:15 - 18:00'} }">
                    <td class="time-col text-center" th:text="${h}"></td>
                    <td th:each="d : ${#numbers.sequence(1,5)}">
                        <button class="add-btn" onclick="openModal(this)">+</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
</main>

<div id="classModal" class="modal-overlay" style="display: none;">
    <div class="modal-content max-w-md w-full m-4">
        <div class="modal-header flex justify-between items-center pb-3 border-b">
            <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-calendar-plus mr-2 text-blue-600"></i>Agregar
                Clase</h3>
            <span class="close-modal cursor-pointer text-gray-500 hover:text-gray-700 text-2xl" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body space-y-4 py-4">
            <div class="form-group">
                <label class="block text-sm font-semibold text-gray-700 mb-1">Buscar Profesor</label>
                <div class="relative">
                    <input type="text" id="buscarDocente"
                           class="form-control w-full pl-3 pr-10 py-2 border border-gray-300 rounded-lg"
                           placeholder="Escriba para buscar..." oninput="filtrarDocentes()">
                </div>
            </div>
            <div class="form-group">
                <label class="block text-sm font-semibold text-gray-700 mb-1">Profesor Responsable</label>
                <select id="modalDocente" class="form-control w-full p-2.5 border border-gray-300 rounded-lg bg-white"
                        onchange="actualizarMateriaPorDocente()" size="4">
                    <option value="" disabled selected>Cargando docentes...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="block text-sm font-semibold text-gray-700 mb-1">Materia</label>
                <input type="text" id="modalMateria"
                       class="form-control w-full p-2.5 border border-gray-300 rounded-lg bg-gray-50" readonly>
            </div>
        </div>
        <div class="modal-footer flex justify-end space-x-3 pt-4 border-t">
            <button class="px-5 py-2.5 border rounded-lg text-gray-700" onclick="closeModal()">Cancelar</button>
            <button class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-semibold" onclick="guardarClase()">
                Confirmar
            </button>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script>
    let currentButton = null;
    let horariosTemporales = [];
    let docentesCache = [];

    function toggleCustomDropdown(id) {
        document.getElementById(id).classList.toggle('active');
        document.querySelectorAll('.custom-dropdown').forEach(d => { if (d.id !== id) d.classList.remove('active'); });
    }

    function selectItem(type, value) {
        document.getElementById(type === 'curso' ? 'textCurso' : 'textParalelo').innerText = value;
        document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active'));
    }

    function openModal(button) {
        const curso = document.getElementById('textCurso').innerText;
        const paralelo = document.getElementById('textParalelo').innerText;
        if (curso === "Seleccionar Curso" || paralelo === "Seleccionar Paralelo") {
            alert("⚠️ Selecciona Curso y Paralelo primero.");
            return;
        }
        currentButton = button;
        document.getElementById('classModal').style.display = 'flex';
        if (docentesCache.length === 0) cargarDocentes();
    }

    function closeModal() {
        document.getElementById('classModal').style.display = 'none';
        document.getElementById('buscarDocente').value = '';
        currentButton = null;
    }

    async function cargarDocentes() {
        try {
            const response = await fetch('/api/docentes');
            docentesCache = await response.json();
            renderizarDocentes(docentesCache);
        } catch (e) { console.error(e); }
    }

    function renderizarDocentes(docentes) {
        const select = document.getElementById('modalDocente');
        select.innerHTML = docentes.map(d => `<option value="${d.id}" data-materia="${d.materia}">${d.nombre}</option>`).join('');
    }

    function filtrarDocentes() {
        const val = document.getElementById('buscarDocente').value.toLowerCase();
        renderizarDocentes(docentesCache.filter(d => d.nombre.toLowerCase().includes(val)));
    }

    function actualizarMateriaPorDocente() {
        const sel = document.getElementById('modalDocente');
        if(sel.selectedIndex !== -1) {
            document.getElementById('modalMateria').value = sel.options[sel.selectedIndex].getAttribute('data-materia');
        }
    }

    async function guardarClase() {
        const select = document.getElementById('modalDocente');
        if (!select.value) return alert("Seleccione un docente");

        const docenteId = select.value;
        const docenteNombre = select.options[select.selectedIndex].text;
        const materia = document.getElementById('modalMateria').value;
        const cell = currentButton.parentElement;
        const tabla = cell.closest('table');
        const dia = tabla.querySelectorAll('thead th')[cell.cellIndex].innerText.trim().toUpperCase();
        const [inicio, fin] = cell.closest('tr').querySelector('.time-col').innerText.split(' - ');
        const horaInicioEnvio = inicio + ":00";
        const cursoActual = document.getElementById('textCurso').innerText;
        const paraleloActual = document.getElementById('textParalelo').innerText.replace("Paralelo ", "");

        // 1. VALIDACIÓN LOCAL (Evitar pisar lo que acabas de poner en pantalla sin guardar)
        const yaAsignadoLocal = horariosTemporales.find(h => 
            h.diaSemana === dia && h.horaInicio === horaInicioEnvio && 
            h.curso === cursoActual && h.paralelo === paraleloActual
        );
        if (yaAsignadoLocal) {
            alert(`❌ Esta celda ya tiene asignada la materia: ${yaAsignadoLocal.materia}`);
            return;
        }

        // 2. VALIDACIÓN CON SERVIDOR (Importante: enviamos curso y paralelo)
        try {
            const url = `/horario/validarCruce?docenteId=${docenteId}&diaSemana=${dia}&horaInicio=${horaInicioEnvio}&curso=${encodeURIComponent(cursoActual)}&paralelo=${encodeURIComponent(paraleloActual)}`;
            const res = await fetch(url);
            
            if (res.ok) {
                const conflicto = await res.json();
                if (conflicto) {
                    // Si el conflicto es en el MISMO CURSO Y PARALELO -> BLOQUEO
                    if (conflicto.curso === cursoActual && conflicto.paralelo === paraleloActual) {
                        alert(`❌ ESPACIO OCUPADO: En el sistema, este curso ya tiene ${conflicto.materia} a esta hora.`);
                        return;
                    }
                    // Si el conflicto es del DOCENTE en OTRO curso -> AVISO
                    alert(`ℹ️ AVISO: El docente ${docenteNombre} ya está ocupado en ${conflicto.curso} (${conflicto.paralelo}) en este horario.`);
                }
            }
        } catch (e) { console.log("Sin conflictos previos detectados."); }

        // 3. REGISTRO
        const tempId = Date.now();
        const registro = {
            tempId,
            curso: cursoActual,
            paralelo: paraleloActual,
            jornada: cell.closest('.schedule-section').querySelector('.section-title').innerText.includes("Matutina") ? "Matutina" : "Vespertina",
            diaSemana: dia, 
            horaInicio: horaInicioEnvio, 
            horaFin: fin + ":00",
            materia: materia,
            docente: { id: parseInt(docenteId) }
        };

        horariosTemporales.push(registro);

        // Renderizado
        cell.innerHTML = `
            <div class="relative group w-full h-full flex flex-col justify-center px-4 py-4 bg-emerald-50 border-l-4 border-l-emerald-500">
                <span class="text-[14px] font-black text-emerald-900 uppercase">${materia}</span>
                <span class="text-[12px] text-emerald-700 truncate font-bold">${docenteNombre}</span>
                <button onclick="resetCell(this, ${tempId})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-all">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </div>`;
        closeModal();
    }

    function resetCell(btn, tid) {
        btn.closest('td').innerHTML = `<button class="add-btn" onclick="openModal(this)">+</button>`;
        horariosTemporales = horariosTemporales.filter(h => h.tempId !== tid);
    }

    async function enviarJornada(jornadaNombre) {
        const data = horariosTemporales.filter(h => h.jornada === jornadaNombre);
        if (data.length === 0) return alert("No hay datos para guardar.");
        
        if (confirm(`¿Guardar todos los cambios de la jornada ${jornadaNombre}?`)) {
            const res = await fetch('/horario/guardarLote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data.map(({tempId, ...rest}) => rest))
            });
            if (res.ok) { 
                alert("¡Horario guardado correctamente!"); 
                location.reload(); 
            } else {
                alert("Ocurrió un error al guardar. Revisa posibles duplicados.");
            }
        }
    }

    window.onclick = (e) => { if (!e.target.closest('.custom-dropdown')) document.querySelectorAll('.custom-dropdown').forEach(d => d.classList.remove('active')); };
</script>

<style>
    .custom-dropdown.active .dropdown-options { display: block !important; }
</style>

</body>
</html>