<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Horario por Curso</title>
    <link rel="icon" th:href="@{/images/faviconLogo.png}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <style>
        @media print {
            .no-print, nav, footer { display: none !important; }
        }

        /* Estilos de impresión para HORARIO POR CURSO - Horizontal */
        @media print {
            @page {
                size: landscape;
                margin: 0.8cm;
            }

            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: white;
                margin: 0;
                padding: 0;
            }

            .max-w-7xl {
                display: block !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 10px !important;
            }

            #contMatutina {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            #tituloJornada {
                display: block !important;
                font-size: 1.2rem !important;
                margin-bottom: 0.5rem !important;
                text-align: center;
            }

            .table-manual {
                border-collapse: collapse;
                width: 100%;
                table-layout: fixed;
                border: 1px solid #d1d5db;
                page-break-inside: avoid;
                font-size: 10px;
            }

            .table-manual th {
                border: 1px solid #d1d5db;
                padding: 6px !important;
                background-color: #f3f4f6 !important;
                color: #000000;
                font-size: 0.9rem;
                font-weight: 800;
                text-transform: uppercase;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .table-manual td {
                border: 1px solid #d1d5db;
                height: 45px !important;
                padding: 3px !important;
                vertical-align: middle;
                background-color: white;
                text-align: center;
            }

            .materia-text {
                font-weight: bold;
                color: #1e40af;
                font-size: 0.8rem;
                text-transform: uppercase;
                display: block;
                line-height: 1.2;
            }

            .docente-text {
                color: #000000;
                font-size: 0.75rem;
                font-style: italic;
                display: block;
                line-height: 1.2;
            }

            .bg-gray-100 {
                background-color: #f3f4f6 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .bg-gray-100 td {
                background-color: #f3f4f6 !important;
                color: #4b5563 !important;
            }

            .main-container, .max-w-7xl, #contMatutina, table {
                page-break-after: avoid;
                page-break-before: avoid;
            }

            body > *:not(.max-w-7xl):not(nav):not(footer) {
                display: none;
            }

            .px-8.mb-10 {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
            }
        }

        /* Estilos normales (pantalla) */
        .table-manual {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
            border: 1px solid #d1d5db;
        }
        .table-manual th {
            border: 1px solid #d1d5db;
            padding: 15px;
            background-color: #f3f4f6;
            color: #000000;
            font-size: 1.1rem;
            font-weight: 800;
            text-transform: uppercase;
        }
        .table-manual td {
            border: 1px solid #d1d5db;
            height: 85px;
            vertical-align: middle;
            background-color: white;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .table-manual td:hover {
            background-color: #f0f9ff;
        }
        .materia-text {
            font-weight: bold;
            color: #1e40af;
            font-size: 1rem;
            text-transform: uppercase;
            display: block;
        }
        .docente-text {
            color: #000000;
            font-size: 1rem;
            font-style: italic;
            display: block;
        }

        tr {
            page-break-inside: avoid;
        }

        /* Modal de Edición */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            ring: 2px solid #3b82f6;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .btn-cancelar {
            background-color: #6b7280;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .btn-guardar {
            background-color: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .btn-cancelar:hover, .btn-guardar:hover {
            filter: brightness(1.1);
        }

        .btn-eliminar-todo {
            background-color: #dc2626;
            color: white;
            padding: 10px 24px;
            border-radius: 9999px;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-eliminar-todo:hover {
            background-color: #b91c1c;
        }

        .btn-imprimir {
            background-color: #1f2937;
            color: white;
            padding: 10px 24px;
            border-radius: 9999px;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-imprimir:hover {
            background-color: #111827;
        }
    </style>
</head>
<body class="bg-gray-50">

<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<div class="max-w-7xl mx-auto p-4 mt-10">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Horario por Curso</h2>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-12 px-8 no-print items-end">
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Curso</label>
            <select id="selectCurso" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="" disabled selected>Seleccione curso...</option>
                <optgroup label="Educación Inicial">
                    <option value="Inicial 1">Inicial 1</option>
                    <option value="Inicial 2">Inicial 2</option>
                </optgroup>
                <optgroup label="Educación Básica">
                    <option value="1ro EGB">1ro EGB</option>
                    <option value="2do EGB">2do EGB</option>
                    <option value="3ro EGB">3ro EGB</option>
                    <option value="4to EGB">4to EGB</option>
                    <option value="5to EGB">5to EGB</option>
                    <option value="6to EGB">6to EGB</option>
                    <option value="7mo EGB">7mo EGB</option>
                    <option value="8vo EGB">8vo EGB</option>
                    <option value="9no EGB">9no EGB</option>
                    <option value="10mo EGB">10mo EGB</option>
                </optgroup>
                <optgroup label="Bachillerato">
                    <option value="1ro BGU">1ro BGU</option>
                    <option value="2do BGU">2do BGU</option>
                    <option value="3ro BGU">3ro BGU</option>
                </optgroup>
            </select>
        </div>
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Paralelo</label>
            <select id="selectParalelo" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="" disabled selected>Seleccione paralelo...</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Jornada</label>
            <select id="selectJornada" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="Matutina">Matutina</option>
                <option value="Vespertina">Vespertina</option>
            </select>
        </div>
        <div>
            <button onclick="cargarHorarios()"
                    class="w-full bg-blue-600 text-white py-2 rounded-md font-bold hover:bg-blue-700">
                CONSULTAR <i class="fas fa-search ml-2"></i>
            </button>
        </div>
    </div>

    <div id="contMatutina" class="px-8 mb-10">
        <p id="tituloJornada" class="font-bold text-gray-900 mb-4 text-2xl uppercase">Jornada Seleccionada</p>
        <table class="table-manual" id="tablaPrincipal">
            <thead>
            <tr class="uppercase text-xs text-gray-500">
                <th class="w-1/6">Hora</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>Miércoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
            </tr>
            </thead>
            <tbody id="cuerpoTabla">
            </tbody>
        </table>
    </div>

    <div class="flex flex-col items-center mt-10 no-print mb-20">
        <div class="flex gap-4">
            <button onclick="exportarAExcel()" class="bg-green-600 text-white py-2 px-10 rounded-full font-bold shadow-md hover:bg-green-700">
                <i class="fas fa-file-excel mr-2"></i>EXCEL
            </button>
            <button onclick="window.print()" class="btn-imprimir">
                IMPRIMIR <i class="fas fa-print ml-2"></i>
            </button>
            <button onclick="eliminarHorarioCompleto()" class="btn-eliminar-todo">
                ELIMINAR TODO <i class="fas fa-trash ml-2"></i>
            </button>
        </div>
    </div>
</div>

<!-- Modal de Edición Simplificado -->
<div id="editModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="text-xl font-bold"><i class="fas fa-edit mr-2 text-blue-600"></i>Cambiar Docente</h3>
            <span class="close-modal cursor-pointer text-gray-500 hover:text-gray-700 text-2xl" onclick="cerrarModalEdicion()">&times;</span>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editId">

            <div class="form-group">
                <label>Materia</label>
                <input type="text" id="editMateria" class="form-control" readonly>
            </div>

            <div class="form-group">
                <label>Docente</label>
                <select id="editDocente" class="form-control" onchange="actualizarMateriaPorDocenteEdit()">
                    <option value="">Cargando...</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancelar" onclick="cerrarModalEdicion()">Cancelar</button>
            <button class="btn-guardar" onclick="guardarCambios()">Cambiar Docente</button>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script>
    const diasIdx = { 'LUNES': 1, 'MARTES': 2, 'MIERCOLES': 3, 'MIÉRCOLES': 3, 'JUEVES': 4, 'VIERNES': 5 };
    let celdaEnEdicion = null;
    let docentesCache = [];

    function generarFilas(jornada) {
        const cuerpo = document.getElementById('cuerpoTabla');
        cuerpo.innerHTML = '';

        if (jornada === 'Matutina') {
            const horasSimples = ['07:00', '07:45', '08:30', '09:15', 'RECREO', '10:30', '11:15'];
            const horasMostrar = ['07:00 - 07:45', '07:45 - 08:30', '08:30 - 09:15', '09:15 - 10:00', 'RECREO', '10:30 - 11:15', '11:15 - 12:00'];

            horasSimples.forEach((horaSimple, index) => {
                const horaMostrar = horasMostrar[index];

                if (horaSimple === 'RECREO') {
                    cuerpo.innerHTML += `<tr class="bg-gray-100"><td class="text-center font-bold text-gray-400 p-2">10:00 - 10:30</td><td colspan="5" class="text-center font-bold text-gray-400">RECREO</td></tr>`;
                } else {
                    cuerpo.innerHTML += `<tr data-hora="${horaSimple}"><td class="p-4 bg-gray-50 text-center font-bold">${horaMostrar}</td><td></td><td></td><td></td><td></td><td></td></tr>`;
                }
            });
        } else { // Jornada Vespertina
            const horasSimples = ['13:00', '13:45', '14:30', '15:15', 'RECREO', '16:30', '17:15'];
            const horasMostrar = ['13:00 - 13:45', '13:45 - 14:30', '14:30 - 15:15', '15:15 - 16:00', 'RECREO', '16:30 - 17:15', '17:15 - 18:00'];

            horasSimples.forEach((horaSimple, index) => {
                const horaMostrar = horasMostrar[index];

                if (horaSimple === 'RECREO') {
                    cuerpo.innerHTML += `<tr class="bg-gray-100"><td class="text-center font-bold text-gray-400 p-2">16:00 - 16:30</td><td colspan="5" class="text-center font-bold text-gray-400">RECREO</td></tr>`;
                } else {
                    cuerpo.innerHTML += `<tr data-hora="${horaSimple}"><td class="p-4 bg-gray-50 text-center font-bold">${horaMostrar}</td><td></td><td></td><td></td><td></td><td></td></tr>`;
                }
            });
        }
    }

    async function cargarHorarios() {
        const curso = document.getElementById('selectCurso').value;
        const paralelo = document.getElementById('selectParalelo').value;
        const jornada = document.getElementById('selectJornada').value;

        if (!curso || !paralelo) {
            alert("Seleccione curso y paralelo.");
            return;
        }

        document.getElementById('tituloJornada').innerText = "Jornada " + jornada;
        generarFilas(jornada);

        try {
            const params = new URLSearchParams({ curso, paralelo, jornada });
            const response = await fetch(`/horario/buscar?${params.toString()}`);

            if (response.status === 400) {
                alert("❌ Error 400: Revisa tu controlador Java.");
                return;
            }
            if (!response.ok) throw new Error("Error " + response.status);

            const data = await response.json();

            if (data.length === 0) {
                alert("ℹ️ No hay datos para esta selección.");
                return;
            }

            data.forEach(h => {
                const dia = h.diaSemana.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const col = diasIdx[dia];
                const horaKey = h.horaInicio.split(':').slice(0,2).join(':');

                const fila = document.querySelector(`tr[data-hora="${horaKey}"]`);
                if (fila && col) {
                    const celda = fila.cells[col];
                    celda.setAttribute('data-horario-id', h.id);
                    celda.setAttribute('onclick', `editarCelda(this, ${h.id})`);
                    celda.innerHTML = `
                        <div class="text-center">
                            <span class="materia-text">${h.materia}</span>
                            <span class="docente-text">${h.docente?.nombre || ''}</span>
                        </div>`;
                }
            });
            alert("✅ Horario cargado.");
        } catch (e) {
            alert("⚠️ Error: " + e.message);
        }
    }

    async function cargarDocentes() {
        try {
            const response = await fetch('/api/docentes');
            docentesCache = await response.json();
        } catch (e) {
            console.error("Error cargando docentes:", e);
        }
    }

    async function editarCelda(elemento, horarioId) {
        try {
            const response = await fetch(`/horario/buscarPorId/${horarioId}`);
            if (!response.ok) throw new Error("No se pudo obtener el horario");

            const horario = await response.json();

            celdaEnEdicion = {
                elemento: elemento,
                horarioId: horarioId,
                celda: elemento.closest('td')
            };

            document.getElementById('editId').value = horario.id;
            document.getElementById('editMateria').value = horario.materia;

            // Cargar docentes en el select
            const select = document.getElementById('editDocente');
            if (docentesCache.length === 0) {
                await cargarDocentes();
            }

            select.innerHTML = '<option value="">Seleccione docente...</option>';
            docentesCache.forEach(d => {
                const option = document.createElement('option');
                option.value = d.id;
                option.textContent = d.nombre;
                option.setAttribute('data-materia', d.materia || '');
                if (horario.docente && d.id === horario.docente.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            document.getElementById('editModal').style.display = 'flex';

        } catch (error) {
            alert("⚠️ Error al cargar datos: " + error.message);
        }
    }

    function actualizarMateriaPorDocenteEdit() {
        const select = document.getElementById('editDocente');
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.value) {
            const materia = selectedOption.getAttribute('data-materia');
            if (materia) {
                document.getElementById('editMateria').value = materia;
            }
        }
    }

    async function guardarCambios() {
        if (!celdaEnEdicion) return;

        const selectDocente = document.getElementById('editDocente');
        if (!selectDocente.value) {
            alert("Seleccione un docente");
            return;
        }

        const docenteNombre = selectDocente.options[selectDocente.selectedIndex].text;
        const materia = document.getElementById('editMateria').value;

        const horarioActualizado = {
            id: celdaEnEdicion.horarioId,
            materia: materia,
            docente: { id: parseInt(selectDocente.value) }
        };

        try {
            const response = await fetch(`/horario/actualizar/${celdaEnEdicion.horarioId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(horarioActualizado)
            });

            if (response.ok) {
                // Actualizar la celda visualmente
                celdaEnEdicion.elemento.innerHTML = `
                    <div class="text-center">
                        <span class="materia-text">${materia}</span>
                        <span class="docente-text">${docenteNombre}</span>
                    </div>`;

                alert("✅ Horario actualizado correctamente");
                cerrarModalEdicion();
            } else {
                const error = await response.text();
                alert("❌ Error al actualizar: " + error);
            }
        } catch (error) {
            alert("⚠️ Error de conexión: " + error.message);
        }
    }

    async function eliminarHorarioCompleto() {
        const curso = document.getElementById('selectCurso').value;
        const paralelo = document.getElementById('selectParalelo').value;
        const jornada = document.getElementById('selectJornada').value;

        if (!curso || !paralelo) {
            alert("Seleccione curso y paralelo primero.");
            return;
        }

        if (!confirm(`¿Está seguro de eliminar TODO el horario de ${curso} - ${paralelo} (${jornada})? Esta acción no se puede deshacer.`)) {
            return;
        }

        try {
            const params = new URLSearchParams({ curso, paralelo, jornada });
            const response = await fetch(`/horario/buscar?${params.toString()}`);
            const horarios = await response.json();

            if (horarios.length === 0) {
                alert("No hay horarios para eliminar.");
                return;
            }

            let eliminados = 0;
            for (const h of horarios) {
                const deleteResponse = await fetch(`/horario/eliminar/${h.id}`, {
                    method: 'DELETE'
                });
                if (deleteResponse.ok) eliminados++;
            }

            // Recargar la tabla vacía
            generarFilas(jornada);
            alert(`✅ ${eliminados} horarios eliminados correctamente`);

        } catch (error) {
            alert("⚠️ Error al eliminar: " + error.message);
        }
    }

    function cerrarModalEdicion() {
        document.getElementById('editModal').style.display = 'none';
        celdaEnEdicion = null;
    }

    // Precargar docentes al iniciar
    window.onload = function() {
        cargarDocentes();
    };
    function exportarAExcel() {
    const curso = document.getElementById('selectCurso').value;
    const paralelo = document.getElementById('selectParalelo').value;
    const jornada = document.getElementById('selectJornada').value;

    if (!curso || !paralelo) {
        alert("Primero debe seleccionar un curso y paralelo");
        return;
    }

    // Obtener la tabla
    const tabla = document.getElementById('tablaPrincipal');
    if (!tabla) return;

    // Crear array de datos para Excel
    const datos = [];

    // Título del horario
    datos.push([`HORARIO: ${curso} - ${paralelo} (${jornada})`]);
    datos.push([]); // Fila vacía

    // Encabezados
    const encabezados = ['Hora'];
    const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
    encabezados.push(...diasSemana);
    datos.push(encabezados);

    // Datos de las filas
    const filas = tabla.querySelectorAll('tbody tr');
    filas.forEach(fila => {
        const celdas = fila.querySelectorAll('td');
        if (celdas.length > 0) {
            const filaDatos = [];

            // Primera celda (hora)
            const horaCelda = celdas[0];
            filaDatos.push(horaCelda.innerText.trim());

            // Verificar si es fila de recreo (tiene colspan)
            if (celdas.length === 1 && fila.classList.contains('bg-gray-100')) {
                // Es la fila de recreo con colspan
                filaDatos.push('RECREO', '', '', '', '');
            } else {
                // Filas normales
                for (let i = 1; i < celdas.length; i++) {
                    const celda = celdas[i];
                    const materiaSpan = celda.querySelector('.materia-text');
                    const docenteSpan = celda.querySelector('.docente-text');

                    if (materiaSpan && docenteSpan) {
                        filaDatos.push(`${materiaSpan.innerText} (${docenteSpan.innerText})`);
                    } else {
                        filaDatos.push(''); // Celda vacía
                    }
                }
            }

            datos.push(filaDatos);
        }
    });

    // Crear libro de Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(datos);

    // Ajustar ancho de columnas
    const colWidths = [
        { wch: 15 }, // Hora
        { wch: 30 }, // Lunes
        { wch: 30 }, // Martes
        { wch: 30 }, // Miércoles
        { wch: 30 }, // Jueves
        { wch: 30 }  // Viernes
    ];
    ws['!cols'] = colWidths;

    // Añadir la hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, 'Horario');

    // Generar nombre del archivo
    const nombreArchivo = `Horario_${curso}_${paralelo}_${jornada}.xlsx`;

    // Descargar archivo
    XLSX.writeFile(wb, nombreArchivo);
}
</script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
</body>
</html>