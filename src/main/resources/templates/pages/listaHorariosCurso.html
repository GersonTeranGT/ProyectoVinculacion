<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Horario por Curso</title>
    <link rel="icon" th:href="@{/images/faviconLogo.png}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <style>
        @media print {
            .no-print, nav, footer { display: none !important; }
        }

        /* Estilos de impresión para HORARIO POR CURSO - Horizontal */
        @media print {
            @page {
                size: landscape;
                margin: 0.8cm;
            }

            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: white;
                margin: 0;
                padding: 0;
            }

            /* Mostrar solo el contenedor principal */
            .max-w-7xl {
                display: block !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 10px !important;
            }

            #contMatutina {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            #tituloJornada {
                display: block !important;
                font-size: 1.2rem !important;
                margin-bottom: 0.5rem !important;
                text-align: center;
            }

            .table-manual {
                border-collapse: collapse;
                width: 100%;
                table-layout: fixed;
                border: 1px solid #d1d5db;
                page-break-inside: avoid;
                font-size: 10px;
            }

            .table-manual th {
                border: 1px solid #d1d5db;
                padding: 6px !important;
                background-color: #f3f4f6 !important;
                color: #000000;
                font-size: 0.9rem;
                font-weight: 800;
                text-transform: uppercase;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .table-manual td {
                border: 1px solid #d1d5db;
                height: 45px !important;
                padding: 3px !important;
                vertical-align: middle;
                background-color: white;
                text-align: center;
            }

            .materia-text {
                font-weight: bold;
                color: #1e40af;
                font-size: 0.8rem;
                text-transform: uppercase;
                display: block;
                line-height: 1.2;
            }

            .docente-text {
                color: #000000;
                font-size: 0.75rem;
                font-style: italic;
                display: block;
                line-height: 1.2;
            }

            /* Asegurar que las filas de recreo se vean */
            .bg-gray-100 {
                background-color: #f3f4f6 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .bg-gray-100 td {
                background-color: #f3f4f6 !important;
                color: #4b5563 !important;
            }

            /* Eliminar páginas en blanco extra */
            .main-container, .max-w-7xl, #contMatutina, table {
                page-break-after: avoid;
                page-break-before: avoid;
            }

            /* No ocultar nada más que lo necesario */
            body > *:not(.max-w-7xl):not(nav):not(footer) {
                display: none;
            }

            /* Mostrar explícitamente el contenedor del horario */
            .px-8.mb-10 {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
            }
        }

        /* Estilos normales (pantalla) - se mantienen igual */
        .table-manual {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
            border: 1px solid #d1d5db;
        }
        .table-manual th {
            border: 1px solid #d1d5db;
            padding: 15px;
            background-color: #f3f4f6;
            color: #000000;
            font-size: 1.1rem;
            font-weight: 800;
            text-transform: uppercase;
        }
        .table-manual td {
            border: 1px solid #d1d5db;
            height: 85px;
            vertical-align: middle;
            background-color: white;
            text-align: center;
        }
        .materia-text { font-weight: bold; color: #1e40af; font-size: 1rem; text-transform: uppercase; display: block; }
        .docente-text { color: #000000; font-size: 1rem; font-style: italic; display: block; }

        /* Evitar saltos de página no deseados */
        tr {
            page-break-inside: avoid;
        }
    </style>
</head>
<body class="bg-gray-50">

<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<div class="max-w-7xl mx-auto p-4 mt-10">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Horario por Curso</h2>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-12 px-8 no-print items-end">
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Curso</label>
            <select id="selectCurso" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="" disabled selected>Seleccione curso...</option>
                <optgroup label="Educación Inicial">
                    <option value="Inicial 1">Inicial 1</option>
                    <option value="Inicial 2">Inicial 2</option>
                </optgroup>
                <optgroup label="Educación Básica">
                    <option value="1ro EGB">1ro EGB</option>
                    <option value="2do EGB">2do EGB</option>
                    <option value="3ro EGB">3ro EGB</option>
                    <option value="4to EGB">4to EGB</option>
                    <option value="5to EGB">5to EGB</option>
                    <option value="6to EGB">6to EGB</option>
                    <option value="7mo EGB">7mo EGB</option>
                    <option value="8vo EGB">8vo EGB</option>
                    <option value="9no EGB">9no EGB</option>
                    <option value="10mo EGB">10mo EGB</option>
                </optgroup>
                <optgroup label="Bachillerato">
                    <option value="1ro BGU">1ro BGU</option>
                    <option value="2do BGU">2do BGU</option>
                    <option value="3ro BGU">3ro BGU</option>
                </optgroup>
            </select>
        </div>
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Paralelo</label>
            <select id="selectParalelo" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="" disabled selected>Seleccione paralelo...</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Jornada</label>
            <select id="selectJornada" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="Matutina">Matutina</option>
                <option value="Vespertina">Vespertina</option>
            </select>
        </div>
        <div>
            <button onclick="cargarHorarios()"
                    class="w-full bg-blue-600 text-white py-2 rounded-md font-bold hover:bg-blue-700">
                CONSULTAR <i class="fas fa-search ml-2"></i>
            </button>
        </div>
    </div>

    <div id="contMatutina" class="px-8 mb-10">
        <p id="tituloJornada" class="font-bold text-gray-900 mb-4 text-2xl uppercase">Jornada Seleccionada</p>
        <table class="table-manual" id="tablaPrincipal">
            <thead>
            <tr class="uppercase text-xs text-gray-500">
                <th class="w-1/6">Hora</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>Miércoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
            </tr>
            </thead>
            <tbody id="cuerpoTabla">
            </tbody>
        </table>
    </div>

    <div class="flex flex-col items-center mt-10 no-print mb-20">
        <button onclick="window.print()" class="bg-gray-800 text-white py-2 px-10 rounded-full font-bold shadow-md">
            IMPRIMIR <i class="fas fa-print ml-2"></i>
        </button>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script>
    const diasIdx = { 'LUNES': 1, 'MARTES': 2, 'MIERCOLES': 3, 'MIÉRCOLES': 3, 'JUEVES': 4, 'VIERNES': 5 };

    function generarFilas(jornada) {
    const cuerpo = document.getElementById('cuerpoTabla');
    cuerpo.innerHTML = '';

    if (jornada === 'Matutina') {
        const horasSimples = ['07:00', '07:45', '08:30', '09:15', 'RECREO', '10:30', '11:15'];
        const horasMostrar = ['07:00 - 07:45', '07:45 - 08:30', '08:30 - 09:15', '09:15 - 10:00', 'RECREO', '10:30 - 11:15', '11:15 - 12:00'];

        horasSimples.forEach((horaSimple, index) => {
            const horaMostrar = horasMostrar[index];

            if (horaSimple === 'RECREO') {
                cuerpo.innerHTML += `<tr class="bg-gray-100"><td class="text-center font-bold text-gray-400 p-2">10:00 - 10:30</td><td colspan="5" class="text-center font-bold text-gray-400">RECREO</td></tr>`;
            } else {
                cuerpo.innerHTML += `<tr data-hora="${horaSimple}"><td class="p-4 bg-gray-50 text-center font-bold">${horaMostrar}</td><td></td><td></td><td></td><td></td><td></td></tr>`;
            }
        });
    } else { // Jornada Vespertina
        const horasSimples = ['13:00', '13:45', '14:30', '15:15', 'RECREO', '16:30', '17:15'];
        const horasMostrar = ['13:00 - 13:45', '13:45 - 14:30', '14:30 - 15:15', '15:15 - 16:00', 'RECREO', '16:30 - 17:15', '17:15 - 18:00'];

        horasSimples.forEach((horaSimple, index) => {
            const horaMostrar = horasMostrar[index];

            if (horaSimple === 'RECREO') {
                cuerpo.innerHTML += `<tr class="bg-gray-100"><td class="text-center font-bold text-gray-400 p-2">16:00 - 16:30</td><td colspan="5" class="text-center font-bold text-gray-400">RECREO</td></tr>`;
            } else {
                cuerpo.innerHTML += `<tr data-hora="${horaSimple}"><td class="p-4 bg-gray-50 text-center font-bold">${horaMostrar}</td><td></td><td></td><td></td><td></td><td></td></tr>`;
            }
        });
    }
}

    async function cargarHorarios() {
        const curso = document.getElementById('selectCurso').value;
        const paralelo = document.getElementById('selectParalelo').value;
        const jornada = document.getElementById('selectJornada').value;

        if (!curso || !paralelo) return alert("Seleccione curso y paralelo.");

        document.getElementById('tituloJornada').innerText = "Jornada " + jornada;
        generarFilas(jornada);

        try {
            const params = new URLSearchParams({ curso, paralelo, jornada });
            // CAMBIO CLAVE: La ruta ahora es /horario/buscar
            const response = await fetch(`/horario/buscar?${params.toString()}`);

            if (response.status === 400) return alert("❌ Error 400: Revisa tu controlador Java.");
            if (!response.ok) throw new Error("Error " + response.status);

            const data = await response.json();

            if (data.length === 0) return alert("ℹ️ No hay datos para esta selección.");

            data.forEach(h => {
                const dia = h.diaSemana.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const col = diasIdx[dia];
                const horaKey = h.horaInicio.split(':').slice(0,2).join(':');

                const fila = document.querySelector(`tr[data-hora="${horaKey}"]`);
                if (fila && col) {
                    fila.cells[col].innerHTML = `
                        <div class="text-center">
                            <span class="materia-text">${h.materia}</span>
                            <span class="docente-text">${h.docente?.nombre || ''}</span>
                        </div>`;
                }
            });
            alert("✅ Horario cargado.");
        } catch (e) {
            alert("⚠️ Error: " + e.message);
        }
    }
</script>
</body>
</html>