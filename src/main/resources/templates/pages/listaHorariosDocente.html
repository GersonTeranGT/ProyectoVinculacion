<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Horario por Docente | U.E. Aida Gallegos</title>
    <link rel="icon" th:href="@{/images/faviconLogo.png}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <style>
        @media print { .no-print, nav, footer { display: none !important; } }
        .table-manual { border-collapse: collapse; width: 100%; table-layout: fixed; border: 1px solid #e5e7eb; }
        .table-manual th, .table-manual td { border: 1px solid #e5e7eb; height: 70px; vertical-align: middle; text-align: center; }
        .materia-badge { font-weight: bold; color: #1e40af; font-size: 1rem; text-transform: uppercase; display: block; }
        .curso-badge { color: black; font-size: 1rem; font-weight: bold; display: block; }
        .highlight-select { background-color: #fef9c3; transition: background 0.3s; }
    </style>
</head>
<body class="bg-gray-50">

<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<div class="max-w-7xl mx-auto p-4 mt-10 main-container">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Horario por Docente</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12 px-8 no-print items-end">
        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">1. Escriba el nombre del Docente</label>
            <input type="text" id="inputBusqueda" oninput="filtrarDocentes()"
                   placeholder="Ej: Juan Perez..."
                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">2. Verifique selección</label>
            <select id="selectDocente"
                    class="w-full p-2 border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-blue-500">
                <option value="" disabled selected>Esperando búsqueda...</option>
                <option th:each="docente : ${docentes}"
                        th:value="${docente.id}"
                        th:text="${docente.nombre}"></option>
            </select>
        </div>

        <div>
            <button onclick="cargarHorarioDocente()"
                    class="w-full bg-blue-600 text-white py-2 rounded-md font-bold hover:bg-blue-700 transition-all shadow-md">
                CONSULTAR HORARIO <i class="fas fa-search ml-2"></i>
            </button>
        </div>
    </div>

    <div class="px-8 mb-10">
        <div class="overflow-x-auto">
            <table class="table-manual w-full">
                <thead class="bg-gray-100">
                <tr class="uppercase text-sm md:text-base font-bold text-black-700 border-b-2 border-gray-200">
                    <th class="p-6 text-left bg-gray-50">Hora</th>
                    <th class="p-6">Lunes</th>
                    <th class="p-6">Martes</th>
                    <th class="p-6">Miércoles</th>
                    <th class="p-6">Jueves</th>
                    <th class="p-6">Viernes</th>
                </tr>
                </thead>
                <tbody id="cuerpoTabla">
                </tbody>
            </table>
        </div>
    </div>

    <div class="flex justify-center no-print mb-20">
        <button onclick="window.print()"
                class="bg-gray-800 text-white py-2 px-10 rounded-full font-bold shadow-md hover:bg-black transition-all">
            IMPRIMIR HORARIO <i class="fas fa-print ml-2"></i>
        </button>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script>
    const diasIdx = { 'LUNES': 1, 'MARTES': 2, 'MIERCOLES': 3, 'MIÉRCOLES': 3, 'JUEVES': 4, 'VIERNES': 5 };
    const horas = ['07:00', '07:45', '08:30', '09:15', '10:30', '11:15', '13:00', '13:45', '14:30', '15:45', '16:30', '17:15', '18:00'];

    // FILTRADO DINÁMICO MEJORADO
    function filtrarDocentes() {
        const input = document.getElementById('inputBusqueda').value.toUpperCase();
        const select = document.getElementById('selectDocente');
        const opciones = select.getElementsByTagName('option');
        let primeraCoincidencia = null;

        for (let i = 1; i < opciones.length; i++) {
            const txtValue = opciones[i].textContent || opciones[i].innerText;
            if (txtValue.toUpperCase().indexOf(input) > -1) {
                opciones[i].style.display = "";
                if (!primeraCoincidencia) primeraCoincidencia = opciones[i].value;
            } else {
                opciones[i].style.display = "none";
            }
        }

        // Si hay una coincidencia clara mientras escribe, la selecciona automáticamente
        if (primeraCoincidencia && input.length > 2) {
            select.value = primeraCoincidencia;
            select.classList.add('highlight-select');
        } else {
            select.classList.remove('highlight-select');
        }
    }

    function inicializarTabla() {
        const cuerpo = document.getElementById('cuerpoTabla');
        cuerpo.innerHTML = '';
        horas.forEach(h => {
            const fila = document.createElement('tr');
            fila.setAttribute('data-hora', h);
            fila.innerHTML = `<td class="bg-gray-50 font-bold text-gray-600">${h}</td><td></td><td></td><td></td><td></td><td></td>`;
            cuerpo.appendChild(fila);
        });
    }

    async function cargarHorarioDocente() {
        const select = document.getElementById('selectDocente');
        const docenteId = select.value;
        const nombreDocente = select.options[select.selectedIndex]?.text;

        if (!docenteId) {
            alert("⚠️ Por favor, seleccione un docente de la lista.");
            return;
        }

        inicializarTabla();

        try {
            const response = await fetch(`/horario/buscarPorDocente?docenteId=${docenteId}`);

            if (response.status === 400) {
                alert("❌ Error 400: El servidor no entiende la solicitud.");
                return;
            }

            const data = await response.json();

            if (!data || data.length === 0) {
                alert(`ℹ️ El docente ${nombreDocente} no tiene horarios registrados aún.`);
                return;
            }

            data.forEach(h => {
                const dia = h.diaSemana.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const col = diasIdx[dia];
                const horaKey = h.horaInicio.split(':').slice(0,2).join(':');

                const fila = document.querySelector(`tr[data-hora="${horaKey}"]`);
                if (fila && col) {
                    fila.cells[col].innerHTML = `
                        <div class="p-1">
                            <span class="materia-badge">${h.materia}</span>
                            <span class="curso-badge">${h.curso} - ${h.paralelo}</span>
                        </div>`;
                }
            });

            alert(`✅ Horario de ${nombreDocente} cargado con éxito.`);

        } catch (error) {
            console.error(error);
            alert("⚠️ Hubo un error al conectar con la base de datos.");
        }
    }

    window.onload = inicializarTabla;
</script>
</body>
</html>